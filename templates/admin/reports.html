{% extends "base.html" %}

{% block title %}Admin Reports - Comolor Pharmacy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-bar me-2"></i>System Reports</h2>
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>
</div>

<!-- Revenue Report -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Monthly Revenue Trend</h5>
            </div>
            <div class="card-body">
                {% if monthly_revenue %}
                <canvas id="revenueChart" height="100"></canvas>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No revenue data available</h6>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-certificate me-2"></i>License Status</h5>
            </div>
            <div class="card-body">
                {% if license_stats %}
                <canvas id="licenseChart" height="150"></canvas>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-certificate fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No license data available</h6>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Top Pharmacies -->
<div class="row g-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Top Pharmacies by Revenue</h5>
            </div>
            <div class="card-body">
                {% if top_pharmacies %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Pharmacy</th>
                                <th class="text-end">Total Paid</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pharmacy_name, total_paid in top_pharmacies %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ pharmacy_name }}</td>
                                <td class="text-end">{{ total_paid|currency }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-store fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No pharmacy data available</h6>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- System Summary -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>System Summary</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 border-end">
                        <h4 class="mb-1 text-primary">{{ license_stats|selectattr('0', 'equalto', 'active')|map(attribute='1')|sum or 0 }}</h4>
                        <small class="text-muted">Active Licenses</small>
                    </div>
                    <div class="col-6">
                        <h4 class="mb-1 text-warning">{{ license_stats|selectattr('0', 'equalto', 'pending')|map(attribute='1')|sum or 0 }}</h4>
                        <small class="text-muted">Pending Licenses</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6 border-end">
                        <h4 class="mb-1 text-success">{{ monthly_revenue|map(attribute='1')|sum or 0|currency }}</h4>
                        <small class="text-muted">Total Revenue</small>
                    </div>
                    <div class="col-6">
                        <h4 class="mb-1 text-info">{{ top_pharmacies|length or 0 }}</h4>
                        <small class="text-muted">Paying Pharmacies</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-download me-2"></i>Export Reports</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Report export functionality is not yet implemented. Future versions will support:
                    <ul class="mt-2 mb-0">
                        <li>PDF report generation</li>
                        <li>CSV data export</li>
                        <li>Email report scheduling</li>
                        <li>Custom date range reports</li>
                    </ul>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100" disabled>
                            <i class="fas fa-file-pdf me-2"></i>Export to PDF
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100" disabled>
                            <i class="fas fa-file-csv me-2"></i>Export to CSV
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-info w-100" disabled>
                            <i class="fas fa-envelope me-2"></i>Email Report
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100" disabled>
                            <i class="fas fa-calendar me-2"></i>Schedule Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
{% if monthly_revenue %}
// Monthly Revenue Chart
const revenueData = {
    labels: [{% for month, revenue in monthly_revenue %}'{{ month.strftime('%b %Y') }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        label: 'Monthly Revenue (KES)',
        data: [{% for month, revenue in monthly_revenue %}{{ revenue }}{% if not loop.last %},{% endif %}{% endfor %}],
        borderColor: 'rgb(13, 110, 253)',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        tension: 0.1
    }]
};

const revenueConfig = {
    type: 'line',
    data: revenueData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'KES ' + value.toLocaleString();
                    }
                }
            }
        }
    }
};

new Chart(document.getElementById('revenueChart'), revenueConfig);
{% endif %}

{% if license_stats %}
// License Status Chart
const licenseData = {
    labels: [{% for status, count in license_stats %}'{{ status.title() }}'{% if not loop.last %},{% endif %}{% endfor %}],
    datasets: [{
        data: [{% for status, count in license_stats %}{{ count }}{% if not loop.last %},{% endif %}{% endfor %}],
        backgroundColor: ['#198754', '#ffc107', '#dc3545']
    }]
};

const licenseConfig = {
    type: 'doughnut',
    data: licenseData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
};

new Chart(document.getElementById('licenseChart'), licenseConfig);
{% endif %}
</script>
{% endblock %}
